name: cmake

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CTEST_OUTPUT_ON_FAILURE: 1

jobs:
  macos:
    name: macOS • ${{ matrix.compiler }} • ${{ matrix.build-type }}
    runs-on: macos-15
    strategy:
        fail-fast: false
        matrix:
            compiler: ["appleclang", "llvm@20", "llvm"]
            build-type: ["debug", "release"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.2 toolchain
        if: matrix.compiler == 'appleclang'
        run: |
          # Use Xcode 16.2 (has Apple Clang 16/AppleClang 26)
          if [ -d "/Applications/Xcode_16.2.app" ]; then
            sudo xcode-select --switch /Applications/Xcode_16.2.app/Contents/Developer
          else
            sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          fi
          xcodebuild -version

      - name: Install dependencies (Homebrew)
        run: |
          brew update
          if [ "${{ matrix.compiler }}" = "llvm@20" ]; then
            brew install llvm@20 ninja ccache openssl@3
          else
            brew install llvm ninja ccache openssl@3
          fi

      - name: Configure LLVM environment
        run: |
          if [ "${{ matrix.compiler }}" = "llvm@20" ]; then
            LLVM_PREFIX="$(brew --prefix llvm@20)"
          else
            LLVM_PREFIX="$(brew --prefix llvm)"
          fi
          echo "LLVM_DIR=${LLVM_PREFIX}/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=${LLVM_PREFIX}/bin:$PATH" >> $GITHUB_ENV
          if [ "${{ matrix.compiler }}" = "llvm" ] || [ "${{ matrix.compiler }}" = "llvm@20" ]; then
            echo "LLVM_BIN=${LLVM_PREFIX}/bin" >> $GITHUB_ENV
          fi
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          echo "OPENSSL_ROOT_DIR=${OPENSSL_PREFIX}" >> $GITHUB_ENV
          echo "OPENSSL_DIR=${OPENSSL_PREFIX}" >> $GITHUB_ENV

      - name: Configure environment
        run: |
          echo "SDKROOT=$(xcrun --show-sdk-path)" >> $GITHUB_ENV
          echo "CCACHE_DISABLE=1" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Show tool versions
        run: |
          cmake --version
          ninja --version
          COMPILER_BIN="${LLVM_BIN:-/usr/bin}"
          "${COMPILER_BIN}/clang" --version

      - name: Setup vcpkg
        run: bash scripts/setup-vcpkg.sh

      - name: Configure
        run: |
          COMPILER_BIN="${LLVM_BIN:-/usr/bin}"
          CMAKE_ARGS=(
            "--preset=${{ matrix.build-type }}"
            "-DCMAKE_C_COMPILER=${COMPILER_BIN}/clang"
            "-DCMAKE_CXX_COMPILER=${COMPILER_BIN}/clang++"
            "-DVCPKG_CHAINLOAD_TOOLCHAIN_FILE="
          )
          if [ -n "${OPENSSL_ROOT_DIR:-}" ]; then
            CMAKE_ARGS+=("-DOPENSSL_ROOT_DIR=${OPENSSL_ROOT_DIR}")
          fi
          if [ -n "${LLVM_DIR:-}" ]; then
            CMAKE_ARGS+=("-DLLVM_DIR=${LLVM_DIR}")
            # Also add Clang_DIR to find ClangConfig.cmake
            CLANG_DIR="$(dirname ${LLVM_DIR})/clang"
            if [ -f "${CLANG_DIR}/ClangConfig.cmake" ]; then
              CMAKE_ARGS+=("-DClang_DIR=${CLANG_DIR}")
            fi
          fi
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build --preset=${{ matrix.build-type }}

      - name: Test
        run: ctest --preset=${{ matrix.build-type }} --output-on-failure

  macos-cxx23:
    name: macOS • llvm@20 • C++23 tests
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Homebrew)
        run: |
          brew update
          brew install llvm@20 ninja ccache openssl@3

      - name: Configure LLVM environment
        run: |
          LLVM_PREFIX="$(brew --prefix llvm@20)"
          echo "LLVM_DIR=${LLVM_PREFIX}/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=${LLVM_PREFIX}/bin:$PATH" >> $GITHUB_ENV
          echo "LLVM_BIN=${LLVM_PREFIX}/bin" >> $GITHUB_ENV
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          echo "OPENSSL_ROOT_DIR=${OPENSSL_PREFIX}" >> $GITHUB_ENV
          echo "OPENSSL_DIR=${OPENSSL_PREFIX}" >> $GITHUB_ENV

      - name: Configure environment
        run: |
          echo "SDKROOT=$(xcrun --show-sdk-path)" >> $GITHUB_ENV
          echo "CCACHE_DISABLE=1" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Show tool versions
        run: |
          cmake --version
          ninja --version
          "${LLVM_BIN}/clang" --version

      - name: Setup vcpkg
        run: bash scripts/setup-vcpkg.sh

      - name: Configure
        run: |
          COMPILER_BIN="${LLVM_BIN}"
          CMAKE_ARGS=(
            "--preset=debug"
            "-DGENTEST_TEST_CXX_STANDARD=23"
            "-DGENTEST_ENABLE_PACKAGE_TESTS=ON"
            "-DCMAKE_C_COMPILER=${COMPILER_BIN}/clang"
            "-DCMAKE_CXX_COMPILER=${COMPILER_BIN}/clang++"
            "-DVCPKG_CHAINLOAD_TOOLCHAIN_FILE="
          )
          if [ -n "${OPENSSL_ROOT_DIR:-}" ]; then
            CMAKE_ARGS+=("-DOPENSSL_ROOT_DIR=${OPENSSL_ROOT_DIR}")
          fi
          if [ -n "${LLVM_DIR:-}" ]; then
            CMAKE_ARGS+=("-DLLVM_DIR=${LLVM_DIR}")
            CLANG_DIR="$(dirname ${LLVM_DIR})/clang"
            if [ -f "${CLANG_DIR}/ClangConfig.cmake" ]; then
              CMAKE_ARGS+=("-DClang_DIR=${CLANG_DIR}")
            fi
          fi
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build --preset=debug

      - name: Test
        run: ctest --preset=debug --output-on-failure

  windows:
    name: Windows • LLVM ${{ matrix.llvm-version }} • ${{ matrix.preset }}
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        llvm-version: ["21.1.4", "20.1.8"]
        preset: ["debug-system", "release-system"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Cache extracted LLVM toolchain
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\llvm\clang+llvm-${{ matrix.llvm-version }}-x86_64-pc-windows-msvc
          key: llvm-${{ runner.os }}-${{ matrix.llvm-version }}

      - name: Download LLVM distribution (tarball)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = "${{ matrix.llvm-version }}"
          $archive = "clang+llvm-$version-x86_64-pc-windows-msvc.tar.xz"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/$archive"
          Invoke-WebRequest -Uri $url -OutFile $archive

      - name: Extract LLVM toolchain
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = "${{ matrix.llvm-version }}"
          $root = Join-Path $env:RUNNER_TEMP "llvm"
          $null = New-Item -ItemType Directory -Force -Path $root
          $archive = Get-Item "clang+llvm-$version-x86_64-pc-windows-msvc.tar.xz"

          # bsdtar extraction on windows runners is extremely slow; use 7-Zip instead.
          $sevenZip = Join-Path $env:ProgramFiles "7-Zip\\7z.exe"
          if (-not (Test-Path $sevenZip)) { $sevenZip = "7z.exe" }

          & $sevenZip x -y $archive.FullName "-o$root"
          $tarPath = Join-Path $root "clang+llvm-$version-x86_64-pc-windows-msvc.tar"
          if (-not (Test-Path $tarPath)) { throw "7-Zip failed to produce tar archive at $tarPath" }
          & $sevenZip x -y $tarPath "-o$root"

          Remove-Item -Force -ErrorAction SilentlyContinue $tarPath
          Remove-Item -Force -ErrorAction SilentlyContinue $archive.FullName

      - name: Configure LLVM environment
        shell: pwsh
        run: |
          $version = "${{ matrix.llvm-version }}"
          $root = Join-Path $env:RUNNER_TEMP "llvm"
          $extracted = Join-Path $root "clang+llvm-$version-x86_64-pc-windows-msvc"
          if (-not (Test-Path $extracted)) { throw "Failed to locate extracted LLVM directory at $extracted" }
          "$extracted\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "LLVM_BIN=$extracted\\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_DIR=$extracted\\lib\\cmake\\llvm" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "Clang_DIR=$extracted\\lib\\cmake\\clang" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install OpenSSL
        shell: pwsh
        run: |
          choco install openssl.light --no-progress

          $roots = New-Object System.Collections.Generic.List[string]
          foreach ($candidate in @(
            "$env:ProgramFiles\\OpenSSL-Win64",
            "$env:ProgramFiles\\OpenSSL",
            "$env:ProgramFiles(x86)\\OpenSSL-Win32",
            "$env:ProgramFiles(x86)\\OpenSSL"
          )) {
            if ($candidate) { $roots.Add($candidate) }
          }

          $regKeys = @(
            "HKLM:\\SOFTWARE\\OpenSSL-Win64",
            "HKLM:\\SOFTWARE\\OpenSSL-Win32",
            "HKLM:\\SOFTWARE\\WOW6432Node\\OpenSSL-Win32",
            "HKLM:\\SOFTWARE\\OpenSSL"
          )
          foreach ($key in $regKeys) {
            if (Test-Path $key) {
              $p = (Get-ItemProperty $key).InstallPath
              if ($p) { $roots.Add($p) }
            }
          }

          $openssl = Get-Command openssl.exe -ErrorAction SilentlyContinue
          if ($openssl) {
            $bin = Split-Path -Parent $openssl.Source
            $root = Split-Path -Parent $bin
            $roots.Add($root)
          }

          $candidateRoots = $roots | Where-Object { $_ -and (Test-Path $_) } | Select-Object -Unique
          if (-not $candidateRoots) { throw "OpenSSL install not found. Checked: $($roots -join ', ')" }

          $libPathSuffixes = @(
            "lib",
            "lib64",
            "lib\\VC",
            "lib\\VC\\x64",
            "lib\\VC\\x64\\MD",
            "lib\\VC\\x64\\MT",
            "lib\\VC\\x64\\MDd",
            "lib\\VC\\x64\\MTd",
            "lib\\VC\\static",
            "lib\\VC\\x64\\static"
          )

          $resolvedRoot = $null
          $resolvedSslLib = $null
          $resolvedCryptoLib = $null

          foreach ($candidateRoot in $candidateRoots) {
            $includeOk = Test-Path (Join-Path $candidateRoot "include\\openssl\\ssl.h")
            if (-not $includeOk) { continue }

            foreach ($suffix in $libPathSuffixes) {
              $libDir = Join-Path $candidateRoot $suffix
              if (-not (Test-Path $libDir)) { continue }

              $sslLib = Join-Path $libDir "libssl.lib"
              $cryptoLib = Join-Path $libDir "libcrypto.lib"
              if ((Test-Path $sslLib) -and (Test-Path $cryptoLib)) {
                $resolvedRoot = $candidateRoot
                $resolvedSslLib = $sslLib
                $resolvedCryptoLib = $cryptoLib
                break
              }
            }

            if ($resolvedRoot) { break }
          }

          if (-not $resolvedRoot) {
            throw "OpenSSL install found but import libraries were not. Checked roots: $($candidateRoots -join ', ')"
          }

          "OPENSSL_ROOT_DIR=$resolvedRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_DIR=$resolvedRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_SSL_LIBRARY=$resolvedSslLib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_CRYPTO_LIBRARY=$resolvedCryptoLib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Show tool versions
        shell: pwsh
        run: |
          cmake --version
          ninja --version
          & (Join-Path $env:LLVM_BIN "clang.exe") --version
          & (Join-Path $env:LLVM_BIN "clang++.exe") --version

      - name: Configure
        shell: pwsh
        run: |
          $cmakeArgs = @(
            "--preset=${{ matrix.preset }}",
            "-DCMAKE_C_COMPILER=$env:LLVM_BIN\\clang.exe",
            "-DCMAKE_CXX_COMPILER=$env:LLVM_BIN\\clang++.exe",
            "-DLLVM_DIR=$env:LLVM_DIR",
            "-DClang_DIR=$env:Clang_DIR",
            "-DOPENSSL_ROOT_DIR=$env:OPENSSL_ROOT_DIR"
          )
          if ($env:OPENSSL_SSL_LIBRARY -and $env:OPENSSL_CRYPTO_LIBRARY) {
            $cmakeArgs += "-DOPENSSL_SSL_LIBRARY=$env:OPENSSL_SSL_LIBRARY"
            $cmakeArgs += "-DOPENSSL_CRYPTO_LIBRARY=$env:OPENSSL_CRYPTO_LIBRARY"
          }
          if ("${{ matrix.preset }}" -eq "debug-system") {
            $cmakeArgs += "-DGENTEST_SKIP_WINDOWS_DEBUG_DEATH_TESTS=ON"
          }
          cmake @cmakeArgs

      - name: Build
        shell: pwsh
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Test
        shell: pwsh
        run: ctest --preset=${{ matrix.preset }} --output-on-failure

      - name: Configure/Build/Test (MSVC)
        if: matrix.preset == 'debug-system'
        shell: pwsh
        run: |
          # Also validate MSVC + LLVM tooling (Debug only).
          $msvcBuildDir = Join-Path $env:GITHUB_WORKSPACE "build\\debug-system-msvc"
          cmake -S . -B $msvcBuildDir -G Ninja `
            -DCMAKE_BUILD_TYPE=Debug `
            -DCMAKE_C_COMPILER=cl `
            -DCMAKE_CXX_COMPILER=cl `
            -DGENTEST_ENABLE_PACKAGE_TESTS=ON `
            -DGENTEST_SKIP_WINDOWS_DEBUG_DEATH_TESTS=ON `
            -DLLVM_DIR="$env:LLVM_DIR" `
            -DClang_DIR="$env:Clang_DIR" `
            -DOPENSSL_ROOT_DIR="$env:OPENSSL_ROOT_DIR" `
            -DOPENSSL_SSL_LIBRARY="$env:OPENSSL_SSL_LIBRARY" `
            -DOPENSSL_CRYPTO_LIBRARY="$env:OPENSSL_CRYPTO_LIBRARY"
          cmake --build $msvcBuildDir
          ctest --test-dir $msvcBuildDir --output-on-failure

  windows-cxx23:
    name: Windows • LLVM 20.1.8 • C++23 tests
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Cache extracted LLVM toolchain
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\llvm\clang+llvm-20.1.8-x86_64-pc-windows-msvc
          key: llvm-${{ runner.os }}-20.1.8

      - name: Download LLVM distribution (tarball)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = "20.1.8"
          $archive = "clang+llvm-$version-x86_64-pc-windows-msvc.tar.xz"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$version/$archive"
          Invoke-WebRequest -Uri $url -OutFile $archive

      - name: Extract LLVM toolchain
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $version = "20.1.8"
          $root = Join-Path $env:RUNNER_TEMP "llvm"
          $null = New-Item -ItemType Directory -Force -Path $root
          $archive = Get-Item "clang+llvm-$version-x86_64-pc-windows-msvc.tar.xz"

          # bsdtar extraction on windows runners is extremely slow; use 7-Zip instead.
          $sevenZip = Join-Path $env:ProgramFiles "7-Zip\\7z.exe"
          if (-not (Test-Path $sevenZip)) { $sevenZip = "7z.exe" }

          & $sevenZip x -y $archive.FullName "-o$root"
          $tarPath = Join-Path $root "clang+llvm-$version-x86_64-pc-windows-msvc.tar"
          if (-not (Test-Path $tarPath)) { throw "7-Zip failed to produce tar archive at $tarPath" }
          & $sevenZip x -y $tarPath "-o$root"

          Remove-Item -Force -ErrorAction SilentlyContinue $tarPath
          Remove-Item -Force -ErrorAction SilentlyContinue $archive.FullName

      - name: Configure LLVM environment
        shell: pwsh
        run: |
          $version = "20.1.8"
          $root = Join-Path $env:RUNNER_TEMP "llvm"
          $extracted = Join-Path $root "clang+llvm-$version-x86_64-pc-windows-msvc"
          if (-not (Test-Path $extracted)) { throw "Failed to locate extracted LLVM directory at $extracted" }
          "$extracted\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "LLVM_BIN=$extracted\\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LLVM_DIR=$extracted\\lib\\cmake\\llvm" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "Clang_DIR=$extracted\\lib\\cmake\\clang" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install OpenSSL
        shell: pwsh
        run: |
          choco install openssl.light --no-progress

          $roots = New-Object System.Collections.Generic.List[string]
          foreach ($candidate in @(
            "$env:ProgramFiles\\OpenSSL-Win64",
            "$env:ProgramFiles\\OpenSSL",
            "$env:ProgramFiles(x86)\\OpenSSL-Win32",
            "$env:ProgramFiles(x86)\\OpenSSL"
          )) {
            if ($candidate) { $roots.Add($candidate) }
          }

          $regKeys = @(
            "HKLM:\\SOFTWARE\\OpenSSL-Win64",
            "HKLM:\\SOFTWARE\\OpenSSL-Win32",
            "HKLM:\\SOFTWARE\\WOW6432Node\\OpenSSL-Win32",
            "HKLM:\\SOFTWARE\\OpenSSL"
          )
          foreach ($key in $regKeys) {
            if (Test-Path $key) {
              $p = (Get-ItemProperty $key).InstallPath
              if ($p) { $roots.Add($p) }
            }
          }

          $openssl = Get-Command openssl.exe -ErrorAction SilentlyContinue
          if ($openssl) {
            $bin = Split-Path -Parent $openssl.Source
            $root = Split-Path -Parent $bin
            $roots.Add($root)
          }

          $candidateRoots = $roots | Where-Object { $_ -and (Test-Path $_) } | Select-Object -Unique
          if (-not $candidateRoots) { throw "OpenSSL install not found. Checked: $($roots -join ', ')" }

          $libPathSuffixes = @(
            "lib",
            "lib64",
            "lib\\VC",
            "lib\\VC\\x64",
            "lib\\VC\\x64\\MD",
            "lib\\VC\\x64\\MT",
            "lib\\VC\\x64\\MDd",
            "lib\\VC\\x64\\MTd",
            "lib\\VC\\static",
            "lib\\VC\\x64\\static"
          )

          $resolvedRoot = $null
          $resolvedSslLib = $null
          $resolvedCryptoLib = $null

          foreach ($candidateRoot in $candidateRoots) {
            $includeOk = Test-Path (Join-Path $candidateRoot "include\\openssl\\ssl.h")
            if (-not $includeOk) { continue }

            foreach ($suffix in $libPathSuffixes) {
              $libDir = Join-Path $candidateRoot $suffix
              if (-not (Test-Path $libDir)) { continue }

              $sslLib = Join-Path $libDir "libssl.lib"
              $cryptoLib = Join-Path $libDir "libcrypto.lib"
              if ((Test-Path $sslLib) -and (Test-Path $cryptoLib)) {
                $resolvedRoot = $candidateRoot
                $resolvedSslLib = $sslLib
                $resolvedCryptoLib = $cryptoLib
                break
              }
            }

            if ($resolvedRoot) { break }
          }

          if (-not $resolvedRoot) {
            throw "OpenSSL install found but import libraries were not. Checked roots: $($candidateRoots -join ', ')"
          }

          "OPENSSL_ROOT_DIR=$resolvedRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_DIR=$resolvedRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_SSL_LIBRARY=$resolvedSslLib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "OPENSSL_CRYPTO_LIBRARY=$resolvedCryptoLib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Show tool versions
        shell: pwsh
        run: |
          cmake --version
          ninja --version
          & (Join-Path $env:LLVM_BIN "clang.exe") --version
          & (Join-Path $env:LLVM_BIN "clang++.exe") --version

      - name: Configure
        shell: pwsh
        run: |
          $cmakeArgs = @(
            "--preset=debug-system-cxx23",
            "-DCMAKE_C_COMPILER=$env:LLVM_BIN\\clang.exe",
            "-DCMAKE_CXX_COMPILER=$env:LLVM_BIN\\clang++.exe",
            "-DGENTEST_SKIP_WINDOWS_DEBUG_DEATH_TESTS=ON",
            "-DLLVM_DIR=$env:LLVM_DIR",
            "-DClang_DIR=$env:Clang_DIR",
            "-DOPENSSL_ROOT_DIR=$env:OPENSSL_ROOT_DIR"
          )
          if ($env:OPENSSL_SSL_LIBRARY -and $env:OPENSSL_CRYPTO_LIBRARY) {
            $cmakeArgs += "-DOPENSSL_SSL_LIBRARY=$env:OPENSSL_SSL_LIBRARY"
            $cmakeArgs += "-DOPENSSL_CRYPTO_LIBRARY=$env:OPENSSL_CRYPTO_LIBRARY"
          }
          cmake @cmakeArgs

      - name: Build
        shell: pwsh
        run: cmake --build --preset=debug-system-cxx23

      - name: Test
        shell: pwsh
        run: ctest --preset=debug-system-cxx23 --output-on-failure

  linux:
    name: ${{ matrix.name }} • ${{ matrix.build_type }}
    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu 24.04 • Clang 20
            container: ubuntu:24.04
            pkg_manager: apt
            compiler: clang
            cc: clang-20
            cxx: clang++-20
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: debug
          - name: Ubuntu 24.04 • Clang 20
            container: ubuntu:24.04
            pkg_manager: apt
            compiler: clang
            cc: clang-20
            cxx: clang++-20
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: release
          - name: Ubuntu 24.04 • GCC
            container: ubuntu:24.04
            pkg_manager: apt
            compiler: gcc
            cc: gcc
            cxx: g++
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: debug
          - name: Ubuntu 24.04 • GCC
            container: ubuntu:24.04
            pkg_manager: apt
            compiler: gcc
            cc: gcc
            cxx: g++
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: release
          - name: Ubuntu 25.04 • Clang 20
            container: ubuntu:25.04
            pkg_manager: apt
            compiler: clang
            cc: clang-20
            cxx: clang++-20
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: debug
          - name: Ubuntu 25.04 • Clang 20
            container: ubuntu:25.04
            pkg_manager: apt
            compiler: clang
            cc: clang-20
            cxx: clang++-20
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: release
          - name: Ubuntu 25.04 • GCC
            container: ubuntu:25.04
            pkg_manager: apt
            compiler: gcc
            cc: gcc
            cxx: g++
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: debug
          - name: Ubuntu 25.04 • GCC
            container: ubuntu:25.04
            pkg_manager: apt
            compiler: gcc
            cc: gcc
            cxx: g++
            clang_version: "20"
            llvm_dir: /usr/lib/llvm-20/lib/cmake/llvm
            clang_dir: /usr/lib/llvm-20/lib/cmake/clang
            build_type: release
          - name: Fedora 41 • Clang
            container: fedora:41
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 41 • Clang
            container: fedora:41
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
          - name: Fedora 41 • GCC
            container: fedora:41
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 41 • GCC
            container: fedora:41
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
          - name: Fedora 42 • Clang
            container: fedora:42
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 42 • Clang
            container: fedora:42
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
          - name: Fedora 42 • GCC
            container: fedora:42
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 42 • GCC
            container: fedora:42
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
          - name: Fedora 43 • Clang
            container: fedora:43
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 43 • Clang
            container: fedora:43
            pkg_manager: dnf
            compiler: clang
            cc: clang
            cxx: clang++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
          - name: Fedora 43 • GCC
            container: fedora:43
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: debug
          - name: Fedora 43 • GCC
            container: fedora:43
            pkg_manager: dnf
            compiler: gcc
            cc: gcc
            cxx: g++
            llvm_dir: /usr/lib64/cmake/llvm
            clang_dir: /usr/lib64/cmake/clang
            build_type: release
    steps:
      - name: Update and install dependencies (apt)
        if: ${{ matrix.pkg_manager == 'apt' }}
        run: |
          set -euxo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            build-essential \
            ccache \
            ninja-build \
            python3 \
            python3-pip \
            pkg-config \
            curl \
            zip \
            unzip \
            tar \
            ca-certificates \
            libffi-dev \
            libxml2-dev \
            libssl-dev \
            zlib1g-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libunwind-dev \
            libfmt-dev \
            clang-${{ matrix.clang_version }} \
            clang-tools-${{ matrix.clang_version }} \
            libclang-${{ matrix.clang_version }}-dev \
            libclang-cpp${{ matrix.clang_version }}-dev \
            llvm-${{ matrix.clang_version }}-dev
          python3 -m pip install --break-system-packages --upgrade cmake
          echo "/usr/lib/llvm-${{ matrix.clang_version }}/bin" >> "$GITHUB_PATH"
      - name: Update and install dependencies (dnf)
        if: ${{ matrix.pkg_manager == 'dnf' }}
        run: |
          set -euxo pipefail
          dnf -y upgrade --refresh
          dnf -y install \
            git \
            which \
            tar \
            xz \
            ccache \
            ninja-build \
            python3 \
            python3-pip \
            pkg-config \
            curl \
            zip \
            unzip \
            clang \
            clang-libs \
            clang-devel \
            clang-tools-extra \
            llvm-devel \
            fmt-devel \
            zlib-ng-compat-devel \
            libunwind-devel \
            libcurl-devel \
            libffi-devel \
            libxml2-devel \
            openssl-devel \
            gcc \
            gcc-c++ \
            make \
            ca-certificates \
            ncurses-compat-libs
          python3 -m pip install --upgrade pip cmake
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure environment variables
        run: |
          echo "LLVM_DIR=${{ matrix.llvm_dir }}" >> $GITHUB_ENV
          echo "Clang_DIR=${{ matrix.clang_dir }}" >> $GITHUB_ENV
          echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV
          echo "PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
      - name: Show tool versions
        run: |
          set -euxo pipefail
          cmake --version
          ninja --version
          ${CC} --version
          clang --version || true
          if command -v llvm-config >/dev/null 2>&1; then llvm-config --version; fi
      - name: Configure
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          set -euxo pipefail
          cmake --preset=${{ matrix.build_type == 'debug' && 'debug-system' || 'release-system' }} \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX} \
            -DLLVM_DIR=${LLVM_DIR} \
            -DClang_DIR=${Clang_DIR}
      - name: Build
        run: |
          set -euxo pipefail
          cmake --build --preset=${{ matrix.build_type == 'debug' && 'debug-system' || 'release-system' }} --parallel
      - name: Test
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          set -euxo pipefail
          ctest --preset=${{ matrix.build_type == 'debug' && 'debug-system' || 'release-system' }} --output-on-failure

  linux-cxx23:
    name: Linux • Ubuntu 24.04 • Clang 20 • C++23 tests
    runs-on: ubuntu-24.04
    container: ubuntu:24.04
    defaults:
      run:
        shell: bash
    steps:
      - name: Update and install dependencies (apt)
        run: |
          set -euxo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            build-essential \
            ccache \
            ninja-build \
            python3 \
            python3-pip \
            pkg-config \
            curl \
            zip \
            unzip \
            tar \
            ca-certificates \
            libffi-dev \
            libxml2-dev \
            libssl-dev \
            zlib1g-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libunwind-dev \
            libfmt-dev \
            clang-20 \
            clang-tools-20 \
            libclang-20-dev \
            libclang-cpp20-dev \
            llvm-20-dev
          python3 -m pip install --break-system-packages --upgrade cmake
          echo "/usr/lib/llvm-20/bin" >> "$GITHUB_PATH"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure environment variables
        run: |
          echo "LLVM_DIR=/usr/lib/llvm-20/lib/cmake/llvm" >> $GITHUB_ENV
          echo "Clang_DIR=/usr/lib/llvm-20/lib/cmake/clang" >> $GITHUB_ENV
          echo "CC=clang-20" >> $GITHUB_ENV
          echo "CXX=clang++-20" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV
          echo "PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV

      - name: Show tool versions
        run: |
          set -euxo pipefail
          cmake --version
          ninja --version
          ${CC} --version
          clang --version || true
          if command -v llvm-config >/dev/null 2>&1; then llvm-config --version; fi

      - name: Configure
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          set -euxo pipefail
          cmake --preset=debug-system-cxx23 \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX} \
            -DLLVM_DIR=${LLVM_DIR} \
            -DClang_DIR=${Clang_DIR}

      - name: Build
        run: |
          set -euxo pipefail
          cmake --build --preset=debug-system-cxx23 --parallel

      - name: Test
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          set -euxo pipefail
          ctest --preset=debug-system-cxx23 --output-on-failure
