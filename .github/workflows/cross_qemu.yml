name: cross-qemu

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CTEST_OUTPUT_ON_FAILURE: 1

jobs:
  linux-aarch64-qemu:
    name: Linux â€¢ aarch64 (QEMU)
    runs-on: ubuntu-24.04
    container: ubuntu:24.04
    defaults:
      run:
        shell: bash
    steps:
      - name: Update and install dependencies (apt)
        run: |
          set -euxo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            git \
            build-essential \
            ninja-build \
            python3 \
            python3-pip \
            pkg-config \
            curl \
            zip \
            unzip \
            tar \
            ca-certificates \
            libssl-dev \
            clang-20 \
            clang-tools-20 \
            libclang-20-dev \
            libclang-cpp20-dev \
            llvm-20-dev \
            libtinfo6 \
            qemu-user \
            libc6-dev-arm64-cross \
            libc6-arm64-cross \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu
          python3 -m pip install --break-system-packages --upgrade cmake
          echo "/usr/lib/llvm-20/bin" >> "$GITHUB_PATH"
          echo "PATH=/usr/local/bin:$PATH" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure environment variables
        run: |
          echo "LLVM_DIR=/usr/lib/llvm-20/lib/cmake/llvm" >> $GITHUB_ENV
          echo "Clang_DIR=/usr/lib/llvm-20/lib/cmake/clang" >> $GITHUB_ENV
          echo "CC=clang-20" >> $GITHUB_ENV
          echo "CXX=clang++-20" >> $GITHUB_ENV
          echo "CMAKE_GENERATOR=Ninja" >> $GITHUB_ENV

      - name: Show tool versions
        run: |
          set -euxo pipefail
          cmake --version
          ninja --version
          ${CC} --version
          aarch64-linux-gnu-gcc --version | head -n 1
          qemu-aarch64 --version | head -n 1
          if command -v llvm-config >/dev/null 2>&1; then llvm-config --version; fi

      - name: Configure host codegen (native)
        run: |
          set -euxo pipefail
          cmake --preset=host-codegen \
            -DCMAKE_C_COMPILER=${CC} \
            -DCMAKE_CXX_COMPILER=${CXX} \
            -DLLVM_DIR=${LLVM_DIR} \
            -DClang_DIR=${Clang_DIR} \
            -DGENTEST_USE_SYSTEM_TERMINFO=ON

      - name: Build host codegen (native)
        run: |
          set -euxo pipefail
          cmake --build --preset=host-codegen --parallel

      - name: Configure cross build (Linux/aarch64)
        run: |
          set -euxo pipefail
          aarch64-linux-gnu-gcc -print-sysroot
          loader="$(aarch64-linux-gnu-gcc -print-file-name=ld-linux-aarch64.so.1)"
          libc="$(aarch64-linux-gnu-gcc -print-file-name=libc.so.6)"
          echo "aarch64 loader: ${loader}"
          echo "aarch64 libc: ${libc}"
          test -e "${loader}"
          test -e "${libc}"

          cmake --preset=aarch64-qemu

      - name: Build cross target (Linux/aarch64)
        run: |
          set -euxo pipefail
          cmake --build --preset=aarch64-qemu --parallel

      - name: Test (QEMU smoke)
        run: |
          set -euxo pipefail
          ctest --preset=aarch64-qemu --output-on-failure
